# Claude Context - Task Force Purple

**Purpose**: Essential operational knowledge for AI assistant context. Gitignored, never commit.

---

## Critical API Endpoints

### Individual Member Update
```bash
curl -X POST "https://taskforce-purple-api.dev-a4b.workers.dev/api/update-member/@sensanders" \
  -H "Authorization: Bearer taskforce_purple_2025_update"
```
- Updates single member (both Phase 1 + Phase 2)
- Syncs to main storage (`members:all`)
- Auto-recalculates tiers
- Accepts `@username` or `@BIOGUIDE_ID` format

### Batch FEC Update (Cron/Manual)
```bash
curl -X POST "https://taskforce-purple-api.dev-a4b.workers.dev/api/update-fec-batch?batch=3" \
  -H "Authorization: Bearer taskforce_purple_2025_update"
```
- Processes 3 members per run (configurable, max 10)
- Two-phase: financial data → PAC details
- Incremental progress saved to KV
- Rate-limit compliant (15s delays)

### Reset PAC Data
```bash
curl -X POST "https://taskforce-purple-api.dev-a4b.workers.dev/api/reset-pac-data" \
  -H "Authorization: Bearer taskforce_purple_2025_update"
```
- Clears all `pacContributions` arrays
- Rebuilds Phase 2 queue
- Use when PAC filtering logic changes

### Remove Member
```bash
curl -X POST "https://taskforce-purple-api.dev-a4b.workers.dev/api/remove-member/S000033" \
  -H "Authorization: Bearer taskforce_purple_2025_update"
```
- Removes member from `members:all` storage
- Forces fresh data fetch on next update
- Use for corrupted data

### Query Members
```bash
# All members
curl -s "https://taskforce-purple-api.dev-a4b.workers.dev/api/members"

# Single member
curl -s "https://taskforce-purple-api.dev-a4b.workers.dev/api/members/S000033"
```

---

## Known Active Issues

### 1. Chamber Misattribution (Bernie = House, should be Senate)
**Cause**: Congress.gov API members list endpoint returns different structure than individual endpoint
- List endpoint: `member.terms?.item?.[0]?.chamber`
- Individual endpoint: `member.terms?.[0]?.chamber`
- Worker uses list endpoint, gets wrong chamber for multi-term members
**Impact**: Display only (cosmetic)
**Priority**: Low

### 2. FEC Totals vs Schedule A Mismatch
**Fixed**: 2025-10-04
- FEC totals endpoint (`other_political_committee_contributions`) can be $0
- Schedule A itemized data shows actual PAC contributions ($82,500)
- **Solution**: Phase 2 now recalculates `pacMoney` from `pacContributions` array
- Redeploy all members if processed before this fix

---

## Data Pipeline Architecture

### Phase 1: Financial Data (3 FEC calls/member)
1. Candidate lookup: `name + state + chamber` → `candidate_id`
2. Committee financial summary: `candidate_id` → `totalRaised`, FEC `pacMoney`
3. Itemized contributions: Committee ID → filter for actual individual donations

**Output**: `totalRaised`, `grassrootsDonations`, `grassrootsPercent`, `pacMoney` (FEC totals), `tier`

### Phase 2: PAC Enhancement (2-5 FEC calls/member)
1. Schedule A PAC contributions: Committee ID → itemized PAC transactions
2. Committee metadata: Per unique PAC → `committee_type`, `designation`
3. **Recalculate pacMoney**: Sum of actual `pacContributions` (overrides Phase 1 FEC totals)
4. Apply transparency weights to PAC amounts

**Output**: `pacContributions[]`, corrected `pacMoney`, updated `grassrootsPercent`, recalculated `tier`

### PAC Filtering (FEC Line Numbers)
```javascript
// Exclude conduit/earmarked (ACTBLUE, WINRED)
if (contrib.line_number === '11AI') return false;

// Exclude other receipts (bank interest, dividends)
if (contrib.line_number === '15') return false;

// Exclude committee transfers
if (['12', '16', '17', '18'].includes(contrib.line_number)) return false;

// Exclude earmarked pass-throughs
if (contrib.conduit_committee_id) return false;
```

**Never use hardcoded text patterns for filtering - use FEC metadata fields only**

### Transparency Weights
```javascript
// Committee Type
'O' (Super PAC): 2.0x penalty
'P' (Candidate): 0.15x discount (85% off)

// Designation
'D' (Leadership PAC): 1.5x penalty
'B' (Lobbyist PAC): 1.5x penalty
'P' (Principal): 0.15x discount
'A' (Authorized): 0.15x discount
```

---

## Rate Limiting

### FEC API
- **Limit**: 1,000 requests/hour (16.67/min)
- **Our usage**: 0.8 calls/min (15-second delays)
- **Safety margin**: 95% under limit

### Smart Batching Strategy
- **Cron schedule**: `*/15 * * * *` (every 15 minutes)
- **Batch size**: 3 Phase 1 + 1 Phase 2 = ~13 FEC calls/run
- **Completion time**: 2-3 days for 538 members

### Cloudflare Worker Limits
- **CPU time**: 30 seconds max
- **Subrequests**: ~50 safe limit
- **Strategy**: Small batches with incremental saves

---

## Storage Structure (KV)

### Main Dataset
**Key**: `members:all`
```json
[
  {
    "bioguideId": "S000033",
    "name": "Sanders, Bernard",
    "totalRaised": 8207886.33,
    "pacMoney": 82500.01,  // Recalculated from pacContributions in Phase 2
    "grassrootsPercent": 98.99,
    "tier": "S",
    "pacContributions": [...],  // Array of 20 PAC objects with metadata
    "pacDetailsStatus": "complete"
  }
]
```

### Processing Queues
**Key**: `processing_queue_phase1` - Members needing financial data
**Key**: `processing_queue_phase2` - Members needing PAC details

### Progress Tracking
**Key**: `batch_progress`
```json
{
  "lastProcessedIndex": 15,
  "phase": "financial"
}
```

---

## Deployment

### Pause Cron
```toml
# wrangler.toml
# [triggers]
# crons = ["*/15 * * * *"]
```
Deploy: `wrangler deploy`

### Enable Cron
```toml
# wrangler.toml
[triggers]
crons = ["*/15 * * * *"]
```
Deploy: `wrangler deploy`

### Frontend Deploy
```bash
npm run build
wrangler pages deploy dist --project-name taskforce-purple
```

---

## Common Operations

### Fix All Members After Code Change
1. Pause cron: Comment out `[triggers]` in wrangler.toml
2. Deploy fix: `wrangler deploy`
3. Reset PAC data: `curl -X POST .../api/reset-pac-data` (if PAC logic changed)
4. Test single member: `curl -X POST .../api/update-member/@sensanders`
5. Enable cron: Uncomment `[triggers]`, `wrangler deploy`
6. Monitor: Check logs with `wrangler tail`

### Debug Individual Member
```bash
# Get current data
curl -s "https://taskforce-purple-api.dev-a4b.workers.dev/api/members/S000033" | jq

# Remove and refresh
curl -X POST "https://taskforce-purple-api.dev-a4b.workers.dev/api/remove-member/S000033" \
  -H "Authorization: Bearer taskforce_purple_2025_update"

curl -X POST "https://taskforce-purple-api.dev-a4b.workers.dev/api/update-member/@sensanders" \
  -H "Authorization: Bearer taskforce_purple_2025_update"
```

### Check Processing Status
```bash
curl -s "https://taskforce-purple-api.dev-a4b.workers.dev/api/status" | jq
```

---

## Important Reminders

1. **NEVER hardcode filters** - Use FEC line numbers and metadata fields
2. **Phase 2 recalculates pacMoney** - Don't trust FEC totals endpoint
3. **Test on Bernie first** - He's the canary (high-profile, edge cases)
4. **Pause cron before fixes** - Prevent bad data propagation
5. **Individual updates sync to main storage** - Use for testing
6. **Check this file before starting work** - Context continuity

---

## Reference Docs

- **API_STRUCTURES.md**: Comprehensive API documentation
- **SMART_BATCHING_STRATEGY.md**: Rate limiting and batch processing details
- **GRASSROOTS_CALCULATION_GUIDE.md**: PAC type classifications
- **README.md**: Public project overview

---

**Last Updated**: 2025-10-04
**Last Major Fix**: Phase 2 pacMoney recalculation (Bernie Sanders $0 → $82,500)
